<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consulta Inventario Chapas</title>

<style>

body{
font-family:Arial;
background:linear-gradient(135deg,#667eea,#764ba2);
color:white;
margin:0;
padding:20px;
}

h1{
text-align:center;
margin-bottom:20px;
}

.filtros{
background:white;
color:black;
padding:15px;
border-radius:8px;
margin-bottom:15px;
display:flex;
gap:10px;
flex-wrap:wrap;
}

input,select{
padding:6px;
font-size:14px;
}

table{
width:100%;
border-collapse:collapse;
background:white;
color:black;
}

th{
background:#333;
color:white;
padding:8px;
cursor:pointer;
}

td{
padding:6px;
border-bottom:1px solid #ddd;
}

tr:hover{
background:#eee;
}

.stock{color:green;font-weight:bold;}
.dias{color:orange;font-weight:bold;}
.fabrica{color:blue;font-weight:bold;}
.sinstock{color:red;font-weight:bold;}

</style>
</head>

<body>

<h1>Consulta Inventario Chapas</h1>

<div class="filtros">

<input id="busquedaGlobal" placeholder="Buscar..." oninput="filtrar()">

<input id="fLargo" placeholder="Largo" oninput="filtrar()">

<input id="fAncho" placeholder="Ancho" oninput="filtrar()">

<input id="fEspesor" placeholder="Espesor" oninput="filtrar()">

<select id="fAleacion" onchange="filtrar()">
<option value="">Todas Aleaciones</option>
</select>

<select id="fTemple" onchange="filtrar()">
<option value="">Todos Temples</option>
</select>

<input id="precioKilo" placeholder="Precio €/kg" oninput="mostrar()">

</div>

<table>

<thead>

<tr>

<th onclick="ordenar('REFERENCIA')">Referencia</th>
<th onclick="ordenar('Largo')">Largo</th>
<th onclick="ordenar('Ancho')">Ancho</th>
<th onclick="ordenar('Espesor')">Espesor</th>
<th onclick="ordenar('Aleación')">Aleación</th>
<th onclick="ordenar('Temple')">Temple</th>
<th onclick="ordenar('Peso Teórico')">Peso</th>
<th onclick="ordenar('estadoTexto')">Estado</th>
<th onclick="ordenar('precioCalc')">Precio €</th>

</tr>

</thead>

<tbody id="tbody"></tbody>

</table>

<script>

let datos=[];
let datosFiltrados=[];
let ordenAsc=true;
let columnaOrden="REFERENCIA";

fetch("./inventario.json?v="+Date.now())
.then(r=>r.json())
.then(json=>{

datos=json;
datosFiltrados=json;

llenarCombos();
filtrar();

});

function llenarCombos(){

let aleaciones=[...new Set(datos.map(x=>x["Aleación"]).filter(Boolean))];
let temples=[...new Set(datos.map(x=>x["Temple"]).filter(Boolean))];

aleaciones.sort().forEach(a=>{
document.getElementById("fAleacion").innerHTML+=`<option>${a}</option>`;
});

temples.sort().forEach(t=>{
document.getElementById("fTemple").innerHTML+=`<option>${t}</option>`;
});

}

function calcularEstado(x){

let t=Number(x["TARRAGONA"])||0;
let v=Number(x["VALENCIA"])||0;
let m=Number(x["MURCIA"])||0;
let p=Number(x["PEDIDAS"])||0;

if(t>=10)
return ["Stock","stock"];

if(t<10 && (v>=10 || m>=10))
return ["7-10 días","dias"];

if(t<10 && v<10 && m<10 && p>0)
return ["Consultar fábrica","fabrica"];

return ["Sin stock","sinstock"];

}

function filtrar(){

let g=document.getElementById("busquedaGlobal").value.toLowerCase();
let largo=document.getElementById("fLargo").value;
let ancho=document.getElementById("fAncho").value;
let espesor=document.getElementById("fEspesor").value;
let aleacion=document.getElementById("fAleacion").value;
let temple=document.getElementById("fTemple").value;

datosFiltrados=datos.filter(x=>{

let estado=calcularEstado(x)[0];

let texto=(JSON.stringify(x)+estado).toLowerCase();

return (!g || texto.includes(g))
&&(!largo || String(x["Largo"])===largo)
&&(!ancho || String(x["Ancho"])===ancho)
&&(!espesor || String(x["Espesor"])===espesor)
&&(!aleacion || x["Aleación"]===aleacion)
&&(!temple || x["Temple"]===temple);

});

mostrar();

}

function mostrar(){

let precioKilo=Number(document.getElementById("precioKilo").value)||0;

let html="";

datosFiltrados.forEach(x=>{

let peso=Number(x["Peso Teórico"])||0;

let precioCalc=(peso*precioKilo).toFixed(2);

let estado=calcularEstado(x);

x.estadoTexto=estado[0];
x.precioCalc=precioCalc;

html+=`

<tr>

<td>${x["REFERENCIA"]||""}</td>
<td>${x["Largo"]||""}</td>
<td>${x["Ancho"]||""}</td>
<td>${x["Espesor"]||""}</td>
<td>${x["Aleación"]||""}</td>
<td>${x["Temple"]||""}</td>
<td>${peso}</td>

<td class="${estado[1]}">${estado[0]}</td>

<td>${precioCalc}</td>

</tr>

`;

});

document.getElementById("tbody").innerHTML=html;

}

function ordenar(col){

ordenAsc=!ordenAsc;

datosFiltrados.sort((a,b)=>{

let v1=a[col]||"";
let v2=b[col]||"";

if(!isNaN(v1) && !isNaN(v2))
return ordenAsc ? v1-v2 : v2-v1;

return ordenAsc ?
String(v1).localeCompare(String(v2)) :
String(v2).localeCompare(String(v1));

});

mostrar();

}

</script>

</body>
</html>
